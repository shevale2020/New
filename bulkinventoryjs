var BulkInventory = {};
(function () {
    var headers = JSON.stringify(SessionVariableData);
    this.Init = function () {
        //File Upload response from the server
        Dropzone.options.dpzoneInventory = {
            maxFiles: 1,
            acceptedFiles: "application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            url: apiUrl + "BulkInventory/UploadInventory",
            headers: {
                "API_KEY": "OIU-ossf-PPooisu877",
                "Authorization": headers
            },
            init: function () {
                myDropzone = this;
                
                //this.on("maxfilesexceeded", function (data) {
                //    var res = eval('(' + data.xhr.responseText + ')');
                //});
                this.on("addedfile", function (file) {
                    $('#dzLoading').show();
                    var isDuplicate = false;
                    if (this.files.length) {
                        var _i, _len;
                        for (_i = 0, _len = this.files.length - 1; _i < _len; _i++) {
                            if (this.files[_i].name === file.name) {
                                isDuplicate = true;
                                console.log("duplikat: " + file.name)
                                this.removeFile(file);
                            }
                        }
                    }

                    if (isDuplicate == true) {
                        toastr.remove();
                        toastrStateConfig();
                        toastr.error("This file already exists.");
                        return;
                    }
                    // Create the remove button
                    var removeButton = Dropzone.createElement("<button class='btn-margin'><i class='fa fa-close fa-lg text-danger'></i></button>");
                    // Capture the Dropzone instance as closure.
                    var _this = this;
                    // Listen to the click event
                    removeButton.addEventListener("click", function (e) {
                        // Make sure the button click doesn't submit the form:
                        e.preventDefault();
                        e.stopPropagation();
                        // Remove the file preview.
                        _this.removeFile(file);
                    });

                    var idbaseDiv = document.createElement('div');
                    idbaseDiv.id = "div" + file.lastModified + file.name.split('.')[1] + file.name.split('.')[0].split(' ')[0].replace(/\#/g, "");
                    idbaseDiv.setAttribute('class', 'text-center btn-cntr');
                    idbaseDiv.appendChild(removeButton);
                    // Add the button to the file preview element.
                    file.previewElement.appendChild(idbaseDiv);

                });
            },
            success: function (file, response, action) {
                $('#dzLoading').hide();
                Dropzone.forElement("#dpzoneInventory").removeAllFiles(true);
                if (response.StatusCode == "200") {
                    toastr.remove();
                    //toastrStateConfig(); toastr['success']('Data Save Successfully.');
                    toastrStateConfig(); toastr['success']('File is uploaded successfully.');
                }
                else if (response.StatusCode == "500" && response.Msg == "File is uploaded successfully.") {
                    toastr.remove();
                    toastrStateConfig(); toastr['success']('File is uploaded successfully.');
                    if (response.StatusCode == "500")
                    { window.location.href = apiUrl.replace("/FAR/", "/") + "Resources/Templates/" + response.URLError; }
                }
                else {

                    window.location.href = apiUrl.replace("/FAR/", "/") + "Resources/Templates/" + response.URLError;
                }

            },
            error: function (file, response, action) {
                $('#dzLoading').hide();
                var msg = '';
                if (response.Message == "Please upload valid file.") {
                    msg = response.Message;
                    toastr.remove();
                    toastrStateConfig();
                    toastr['error'](msg);
                }
                else {
                    msg = response.Message.split('#');
                    toastr.remove();
                    toastrStateConfig(); toastr['error'](msg[0]);
                    switch (msg[1]) {
                        case "1":
                            window.location.href = apiUrl.replace("/FAR/", "/") + "Resources/Templates" + msg[2] + ".xlsx"
                            break;
                        case "2":
                            window.location.href = apiUrl.replace("/FAR/", "/") + "Resources/Templates/" + msg[2] + ".xlsx"
                            break;
                    }


                }

            }
        };

        $('#btnDownload').click(function () {
            if ($('#txtPonumber').val() != "" && $('#drpgrnnumber :selected').text() != "") {
                var PONumber = $('#txtPonumber').val();
                GRNNumber = $('#drpgrnnumber').val();
                var searchText = { PoNumber: PONumber, GRNNumber: GRNNumber.toString() };
                var params = $.extend({}, doAjax_params_default);
                params['url'] = '/BulkInventory/DownloadInventory';
                params['requestType'] = "POST";
                params['contentType'] = "application/json";
                params['data'] = searchText;
                params['successCallbackFunction'] = DownloadInventory;
                doAjax(params);
            }
            else {
                window.location.href = DirectURL;
            }
        });

        function DownloadInventory(msg) {
            window.location.href = apiUrl.replace("/FAR/", "/") + "Resources/Templates/" + msg + ".xlsx"
        }
    };
}).apply(BulkInventory);
