--------------------------------------------------------- Laptop ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 Declare @Qty int ;
DECLARE @dlap TABLE (PONumber NVARCHAR(100), GRNNumber NVARCHAR(100),  ASSET_TYPE NVARCHAR(50), TAG_COUNT NVARCHAR(50), TAG_TYPE NVARCHAR(50), EXP_TYPE NVARCHAR(50), MAJOR_CATEGORY NVARCHAR(500),MINOR_CATEGORY NVARCHAR(500),      
SubMinorCategory NVARCHAR(500), Location NVARCHAR(max),     INV_TYPE NVARCHAR(50),     QUANTITY NVARCHAR(50),       ItemCode NVARCHAR(50),    
 Po_line_id NVARCHAR(50),  VendorName NVARCHAR(MAX),   PODate NVARCHAR(50), GRNDate NVARCHAR(50), SubMinCategory NVARCHAR(MAX), AllocationTypeLaptopID  NVARCHAR(MAX), StockStatusLaptopID  NVARCHAR(MAX),Repeat  INT);


DECLARE @dlap1 TABLE (PONumber NVARCHAR(100), GRNNumber NVARCHAR(100),  ASSET_TYPE NVARCHAR(50), TAG_COUNT NVARCHAR(50), TAG_TYPE NVARCHAR(50), EXP_TYPE NVARCHAR(50), MAJOR_CATEGORY NVARCHAR(500),MINOR_CATEGORY NVARCHAR(500),      
SubMinorCategory NVARCHAR(500), Location NVARCHAR(max),     INV_TYPE NVARCHAR(50),     QUANTITY NVARCHAR(50),       ItemCode NVARCHAR(50),    
 Po_line_id NVARCHAR(50),  VendorName NVARCHAR(MAX),   PODate NVARCHAR(50), GRNDate NVARCHAR(50), SubMinCategory NVARCHAR(MAX), AllocationTypeLaptopID  NVARCHAR(MAX), StockStatusLaptopID  NVARCHAR(MAX),Repeat  INT);


;with CTELap as(
 select --distinct -- top 1 
   a.PONumber
 ,  b.GRNNumber
 , isnull(c.ASSET_TYPE,'IT') as ASSET_TYPE
,c.TAG_COUNT
,c.TAG_TYPE
,c.EXP_TYPE
,c.MAJOR_CATEGORY
,c.MINOR_CATEGORY
, '' as SubMinorCategory
, c.INVENTORY_ORG as Location
,c.INV_TYPE
,((cast( CAST(LTRIM(RTRIM(b.QUANTITY)) as decimal) as bigint )) ) as QUANTITY
,a.ItemCode 
,'' as Po_line_id
,a.VendorName
,a.POCreationDate as PODate
,b.GRNDate
, '<option value=''''> </option>'+@SubMinorCategory as SubMinCategory
,'<option value=''''> </option>'+@AllocationTypeLaptopdrp as AllocationTypeLaptopID
,'<option value=''''> </option>'+@StockStatusLaptopdrp as StockStatusLaptopID
,d.[DateOfAcquisition]
,(c.TAG_COUNT * ((cast( CAST(LTRIM(RTRIM(b.QUANTITY)) as decimal) as bigint )) )) as Repeat
 from WNS_PO_DETAILS_V(nolock) a inner join WNS_RCV_TRANSACTIONS(nolock) b
 on a.PONumber=b.PONumber and a.ItemCode=b.ItemCode AND   a.LineNum=b.PO_LINE_NUM
 inner join WNS_ITEM_MSTER_V (nolock)c on c.ItemCode=a.ItemCode and c.INVENTORY_ORG=a.INVENTORY_ORG
 inner join WNS_ASSET_DETAILS_V (nolock) d on d.PONumber=a.PONumber
 where 
-- a.PONumber= '3640000145' and GRNNumber='5640000462'
a.PONumber=@PONumber  and (@GRNNumber  is null or @GRNNumber ='' or GRNNumber=@GRNNumber )
 and INV_TYPE='Laptop'
 and b.QUANTITY is not null
 )



select @Qty=(select top(1) ((cast( CAST(LTRIM(RTRIM(QUANTITY)) as decimal) as bigint )) ) as QUANTITY from 
[dbo].[WNS_RCV_TRANSACTIONS] WHERE  PONumber=@PONumber and GRNNumber=@GRNNumber)

;with TAGN as(
Select  top( @Qty )t1.TAGNumber
from TD_TAG t1
inner join TD_TAGMaster t2 on t1.TAGMasterId=t2.TAGMasterId
where PONumber=@PONumber and GRNNumber=@GRNNumber
Except
Select t1.TAGNumber
from TD_InventoryCommonDetail t1
inner join TD_Inventory t2 on t1.InventoryId=t2.InventoryId
where PONumber=@GRNNumber and GRNNumber=@GRNNumber
)

 INSERT @dlap
 SELECT * FROM CTELap
cross apply TAGN 

-- INSERT @dlap
-- SELECT * FROM CTELap

-- DECLARE @maxRecursion1 INT

----SELECT MAX(Repeat) FROM @d
--SET @maxRecursion1 = (SELECT MAX(Repeat) FROM @dlap);    


--WITH Iterator AS 
--(
--    SELECT 1 AS Iterations
--    UNION ALL
--    SELECT Iterations + 1 FROM Iterator WHERE Iterations < @maxRecursion1
--)



--INSERT INTO @dlap1
--SELECT A.*
--  FROM @dlap AS A
--RIGHT JOIN Iterator ON Iterator.Iterations <= (A.Repeat)
---- ORDER BY Job ASC
--OPTION (MAXRECURSION 0)




  select 
 ct.PoNumber,ct.GRNNumber,
 ASSET_TYPE,TAG_COUNT,TAG_TYPE,EXP_TYPE,MAJOR_CATEGORY,MINOR_CATEGORY
,  SubMinorCategory,  Location,INV_TYPE,( count(ct.QUANTITY)-isnull(LapAddedCnt,0)) as QUANTITY
,ct.ItemCode, Po_line_id--,LineDescription
,VendorName,PODate,GRNDate,SubMinCategory,AllocationTypeLaptopID,StockStatusLaptopID
 from @dlap ct  left join @Lap d on d.ItemCode=ct.ItemCode 
  where ASSET_TYPE='IT' and TAG_TYPE='Taggable'
  group by
  ct.PoNumber,ct.GRNNumber,ct.ItemCode,ASSET_TYPE,TAG_COUNT,TAG_TYPE,EXP_TYPE,MAJOR_CATEGORY,MINOR_CATEGORY,  SubMinorCategory
,  Location,INV_TYPE, Po_line_id--,LineDescription
,VendorName,LapAddedCnt,PODate,GRNDate,SubMinCategory, AllocationTypeLaptopID,StockStatusLaptopID
